<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ data.title }}</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    const data    = {{ data|tojson }};
    const relv    = {{ relv|tojson }};
    const kpTitle = {{ titledata|tojson }};
  </script>
</head>
<body class="bg-black text-white min-h-screen overflow-x-hidden">

  <!-- FX + helpers -->
  <canvas id="fx-stars" aria-hidden="true"></canvas>
  <div id="magnifier-lens" aria-hidden="true"></div>
  <div id="cursor-glow" aria-hidden="true"></div>
  <div id="scroll-progress" aria-hidden="true"></div>

  <!-- Orbs -->
  <div class="orb a -top-40 -left-40 w-[38rem] h-[38rem]"></div>
  <div class="orb b -bottom-40 -right-40 w-[40rem] h-[40rem]"></div>
  <div class="orb c top-1/3 left-1/2 -translate-x-1/2 w-[42rem] h-[42rem]"></div>

  <!-- Header -->
  <header class="p-6 md:p-8">
    <div class="neon rounded-3xl border border-zinc-800 bg-gradient-to-br from-zinc-900/90 to-black/90 p-6 md:p-8 backdrop-blur">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
        <div>
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-zinc-800 bg-zinc-900/70 text-xs text-zinc-300">
            Live compare • <span class="text-sky-300">OpenAtlas</span> vs <span class="text-amber-300">Kulturpool</span>
          </div>
          <h1 class="text-4xl md:text-6xl mt-3 font-bold leading-tight">{{ data.title }}</h1>
        </div>
        <div class="flex items-center gap-3">
          <span class="px-3 py-1 rounded-full text-xs border border-sky-700/40 bg-sky-500/10 text-sky-300">OpenAtlas</span>
          <span class="px-3 py-1 rounded-full text-xs border border-amber-700/40 bg-amber-500/10 text-amber-300">Kulturpool</span>
          <button style="display:none" id="swapBtn"
                  class="px-3 py-2 text-sm rounded-xl border border-zinc-800 bg-zinc-900/70 hover:bg-zinc-800 transition">
            Swap sides
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Split container -->
  <div id="splitWrap" class="px-6 md:px-8">
    <div class="relative rounded-3xl overflow-hidden border border-zinc-800 bg-zinc-950/60 backdrop-blur-xl">
      <div id="panels" class="grid grid-cols-1 lg:grid-cols-2">

        <!-- LEFT: OpenAtlas -->
        <section id="leftPanel" class="p-6 md:p-8 space-y-8 border-b lg:border-b-0 lg:border-r border-zinc-800">
          <div class="sticky top-2 z-10">
            <div class="flex items-center justify-between rounded-2xl border border-sky-800/40 bg-sky-900/20 px-4 py-3 backdrop-blur">
              <div class="flex items-center gap-2">
                <span class="h-2.5 w-2.5 rounded-full bg-sky-400 animate-pulse"></span>
                <h2 class="text-2xl font-bold tracking-tight">OpenAtlas</h2>
              </div>
              <span class="text-xs px-2 py-1 rounded-full bg-sky-500/15 text-sky-300 border border-sky-700/40">Source</span>
            </div>
          </div>

          {% if data.files %}
          <div class="neon rounded-3xl bg-zinc-900/80 backdrop-blur border border-zinc-800 p-6 md:p-8">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-3xl text-sky-300">Gallery</h3>
              <span class="text-[10px] uppercase tracking-wider text-sky-300/70">OpenAtlas</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
              {% for m in data.files %}
              <figure class="group relative overflow-hidden rounded-2xl border border-zinc-800 bg-zinc-900/40">
                <img src="{{ m.IIIFBasePath }}/full/full/0/default.jpg" alt="{{ m.title }}"
                     class="object-cover w-full h-64 md:h-72 transform group-hover:scale-105 transition duration-700">
                <figcaption class="absolute bottom-0 left-0 w-full bg-black/70 text-white text-sm p-3 opacity-0 group-hover:opacity-100 transition">
                  {{ m.title }}
                </figcaption>
                <div class="absolute top-3 left-3 text-[10px] px-2 py-0.5 rounded-full bg-sky-600/20 text-sky-200 border border-sky-700/50">OpenAtlas</div>
              </figure>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <div class="neon rounded-3xl bg-zinc-900/80 backdrop-blur border border-zinc-800 p-6 md:p-8">
            <h3 class="text-3xl mb-4 text-sky-300">Description</h3>
            <div class="prose prose-invert max-w-none text-lg leading-relaxed">{{ data.description }}</div>
          </div>

          {% if data.relations %}
          <div class="neon rounded-3xl bg-zinc-900/80 backdrop-blur border border-zinc-800 p-6 md:p-8">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-3xl text-sky-300">Relations</h3>
              <span class="text-[10px] uppercase tracking-wider text-sky-300/70">OpenAtlas</span>
            </div>
            {% for type, entities in data.relations.items() %}
              <p style="margin: 2rem;" class="text-xl font-bold">{{ type }}</p>
              <div class="grid sm:grid-cols-2 gap-4 md:gap-6">
                {% for entity in entities %}
                <div class="bg-zinc-800/70 rounded-2xl p-5 border border-sky-800/30 hover:bg-zinc-800 transition">
                  <p class="uppercase text-xs tracking-wider text-gray-400"><a href="/{{ entity.id }}">{{ entity.title }}</a></p>
                </div>
                {% endfor %}
              </div>
            {% endfor %}
          </div>
          {% endif %}
        </section>

        <!-- RIGHT: Kulturpool -->
        <aside id="rightPanel" class="p-6 md:p-8 space-y-8">
          <div class="sticky top-2 z-10">
            <div class="flex items-center justify-between rounded-2xl border border-amber-800/40 bg-amber-900/20 px-4 py-3 backdrop-blur">
              <div class="flex items-center gap-2">
                <span class="h-2.5 w-2.5 rounded-full bg-amber-400 animate-pulse"></span>
                <h2 class="text-2xl font-bold tracking-tight">Kulturpool</h2>
              </div>
              <span class="text-xs px-2 py-1 rounded-full bg-amber-500/15 text-amber-300 border border-amber-700/40">Source</span>
            </div>
          </div>

          <!-- Most relevant (all) -->
<div class="neon rounded-3xl bg-zinc-900/80 backdrop-blur border border-zinc-800 p-6 md:p-8">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-2xl text-amber-300">
      Most relevant
      <span id="relv-count" class="ml-2 align-middle text-xs px-2 py-0.5 rounded-full border border-amber-700/40 bg-amber-500/10 text-amber-300">0</span>
    </h3>
    <span class="text-[10px] uppercase tracking-wider text-amber-300/70">Kulturpool</span>
  </div>
  <div id="kp-grid-relv" class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6"></div>
</div>

<!-- Others (17 initial, +18 per click) -->
<div class="neon rounded-3xl bg-zinc-900/80 backdrop-blur border border-zinc-800 p-6 md:p-8">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-2xl text-amber-300">
      Others
      <span id="others-count" class="ml-2 align-middle text-xs px-2 py-0.5 rounded-full border border-amber-700/40 bg-amber-500/10 text-amber-300">0</span>
    </h3>
    <span class="text-[10px] uppercase tracking-wider text-amber-300/70">Kulturpool</span>
  </div>
  <div id="kp-grid-others" class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6"></div>
</div>


      <!-- Draggable separator -->
      <div id="handle" class="drag-handle" aria-label="Resize panels" role="separator" aria-orientation="vertical">
        <div class="drag-dot">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="opacity-80">
            <path d="M10 6h4v2h-4V6zm0 10h4v2h-4v-2zm0-5h4v2h-4v-2z"/>
          </svg>
        </div>
      </div>
    </aside></div>
  </div>

  <footer class="px-6 md:px-8 py-10 text-center text-xs text-zinc-500">OpenAtlas × Kulturpool comparison UI</footer>

  <script>

      function truncate(text, maxLength = 100) {
        if (!text) return '';
        return text.length > maxLength ? text.slice(0, maxLength) + '…' : text;
    }
  /* split drag */
  (function () {
    const wrap = document.getElementById('splitWrap');
    const panels = document.getElementById('panels');
    const handle = document.getElementById('handle');
    let x = 50, dragging = false;
    const set = pct => { x = Math.min(85, Math.max(15, pct)); handle.style.setProperty('--x', x + '%'); panels.style.gridTemplateColumns = x + '% ' + (100 - x) + '%'; };
    set(x);
    const onMove = e => { if (!dragging) return; const r = wrap.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; set((clientX - r.left) / r.width * 100); };
    const stop = () => dragging = false;
    handle.addEventListener('mousedown', () => dragging = true);
    handle.addEventListener('touchstart', () => dragging = true, {passive:true});
    window.addEventListener('mousemove', onMove);
    window.addEventListener('touchmove', onMove, {passive:false});
    window.addEventListener('mouseup', stop);
    window.addEventListener('touchend', stop);
  })();

  /* Kulturpool: relv all; others paginated 17 +18 + counters */
(function(){
  function normalize(arr){
    return Array.isArray(arr)
      ? arr.filter(m => m && (m.previewImage||m.thumbnail) && (m.isShownAt||m.link||m.url))
      : [];
  }
  const imgUrl  = m => m.previewImage || m.thumbnail;
  const linkUrl = m => m.isShownAt || m.link || m.url || '#';
  const titleOf = m => (m.title || m.name || '').toString();

  function tileFor(m){
    const fig = document.createElement('figure');
    fig.className = "group relative overflow-hidden rounded-2xl border border-zinc-800 bg-zinc-900/40";
    fig.innerHTML = `
      <a href="${linkUrl(m)}" target="_blank" rel="noopener">
        <img src="${imgUrl(m)}" alt="${titleOf(m).replace(/"/g,'&quot;')}" loading="lazy"
             class="object-cover w-full h-64 md:h-72 transform group-hover:scale-105 transition duration-700">
      </a>
      <figcaption class="absolute bottom-0 left-0 w-full bg-black/70 text-white text-sm p-3 opacity-0 group-hover:opacity-100 transition">
        ${truncate(titleOf(m)) || '&nbsp;'}
      </figcaption>
      <div class="absolute top-3 left-3 text-[10px] px-2 py-0.5 rounded-full bg-amber-600/20 text-amber-200 border border-amber-700/50">Kulturpool</div>`;
    return fig;
  }

  /* MOST RELEVANT: render all + set counter */
  (function(){
    const grid  = document.getElementById('kp-grid-relv');
    if (!grid) return;
    const items = normalize(relv);

    const badge = document.getElementById('relv-count');
    if (badge) badge.textContent = items.length;

    if (!items.length){
      grid.innerHTML = '<div class="text-sm text-zinc-400">No results.</div>';
      return;
    }
    items.forEach(m => grid.appendChild(tileFor(m)));
  })();

  /* OTHERS: 17 initial, +18 per click, 18th tile is button + set counter */
  (function(){
    const grid  = document.getElementById('kp-grid-others');
    if (!grid) return;
    const items = normalize(kpTitle);

    const badge = document.getElementById('others-count');
    if (badge) badge.textContent = items.length;

    if (!items.length){
      grid.innerHTML = '<div class="text-sm text-zinc-400">No results.</div>';
      return;
    }

    let idx = 0;
    const INITIAL_BATCH = 17, LOAD_MORE_BATCH = 18;

    function makeLoadMore(hasMore){
      const btn = document.createElement('button');
      btn.type = "button";
      btn.dataset.role = "load-more";
      btn.className = "rounded-2xl border border-amber-700/40 bg-amber-500/10 hover:bg-amber-500/20 transition p-0 overflow-hidden";
      btn.innerHTML = `
        <div class="h-64 md:h-72 w-full flex flex-col items-center justify-center gap-2">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor" class="opacity-80"><path d="M12 5v14m-7-7h14"/></svg>
          <span class="text-amber-300 font-semibold tracking-wide">${hasMore ? 'Load more' : 'No more results'}</span>
        </div>`;
      btn.disabled = !hasMore;
      if (hasMore) btn.addEventListener('click', renderBatch);
      return btn;
    }

    function applyStreamIn(el, i){
      const dir = Math.random() < .5 ? 1 : -1;
      el.style.setProperty('--sx',  (dir * (80 + Math.random()*120)) + 'px');
      el.style.setProperty('--sy',  (40 + Math.random()*90) + 'px');
      el.style.setProperty('--rot', (dir * (6  + Math.random()*10))  + 'deg');
      el.style.setProperty('--delay', (i * 35) + 'ms');
      el.classList.add('stream-in');
      el.addEventListener('animationend', () => {
        el.classList.remove('stream-in');
        el.style.removeProperty('--sx');
        el.style.removeProperty('--sy');
        el.style.removeProperty('--rot');
        el.style.removeProperty('--delay');
      }, { once: true });
    }

    function renderBatch(){
      const last = grid.lastElementChild;
      if (last && last.dataset && last.dataset.role === 'load-more') grid.removeChild(last);

      const count = (idx === 0) ? INITIAL_BATCH : LOAD_MORE_BATCH;
      const end = Math.min(idx + count, items.length);

      let k = 0;
      for (; idx < end; idx++){
        const card = tileFor(items[idx]);
        applyStreamIn(card, k++);
        grid.appendChild(card);
      }
      grid.appendChild(makeLoadMore(idx < items.length));
    }

    renderBatch();
  })();
})();


  /* Magnifier over images */
  (function(){
    const lens = document.getElementById('magnifier-lens');
    if (!lens) return;

    const SIZE  = 200;   // sync with CSS
    const SCALE = 2.4;
    const R = SIZE / 2;

    const selector = '#leftPanel img, #kp-grid-relv img, #kp-grid-others img';
    let activeImg = null, rect = null;

    function onEnter(e){
      activeImg = e.currentTarget;
      rect = activeImg.getBoundingClientRect();
      lens.style.display = 'block';
      lens.style.width = lens.style.height = SIZE + 'px';
      lens.style.backgroundImage =
        `radial-gradient(closest-side, rgba(0,0,0,0) 72%, rgba(0,0,0,.35) 86%, rgba(0,0,0,.65) 100%), url("${activeImg.src}")`;
      const bw = rect.width * SCALE, bh = rect.height * SCALE;
      lens.style.backgroundSize = `${SIZE}px ${SIZE}px, ${bw}px ${bh}px`;
      move(e);
    }
    function onLeave(){ activeImg = null; lens.style.display = 'none'; }
    function move(e){
      if (!activeImg) return;
      rect = activeImg.getBoundingClientRect();
      const x = e.clientX - rect.left, y = e.clientY - rect.top;
      const cx = Math.max(0, Math.min(rect.width,  x));
      const cy = Math.max(0, Math.min(rect.height, y));
      lens.style.transform = `translate(${e.clientX - R}px, ${e.clientY - R}px)`;
      const bx = -(cx * SCALE - R), by = -(cy * SCALE - R);
      lens.style.backgroundPosition = `center, ${bx}px ${by}px`;
    }
    function bind(img){
      img.addEventListener('mouseenter', onEnter, {passive:true});
      img.addEventListener('mousemove',  move,    {passive:true});
      img.addEventListener('mouseleave', onLeave, {passive:true});
    }
    document.querySelectorAll(selector).forEach(bind);
    const mo = new MutationObserver(muts=>{
      muts.forEach(m=>{
        m.addedNodes && m.addedNodes.forEach(n=>{
          if (n.nodeType !== 1) return;
          if (n.matches && n.matches('img')) bind(n);
          n.querySelectorAll && n.querySelectorAll('img').forEach(bind);
        });
      });
    });
    mo.observe(document.body, {subtree:true, childList:true});
  })();

  /* Scroll progress + cursor glow + stars */
  (function(){
    const bar = document.getElementById('scroll-progress');
    const glow = document.getElementById('cursor-glow');

    function onScroll(){
      const h = document.documentElement;
      const p = (h.scrollTop) / (h.scrollHeight - h.clientHeight);
      if (bar) bar.style.transform = `scaleX(${Math.max(0, Math.min(1, p))})`;
    }
    onScroll();
    window.addEventListener('scroll', onScroll, {passive:true});

    if (glow){
      window.addEventListener('mousemove', e => {
        glow.style.transform = `translate(${e.clientX - 150}px, ${e.clientY - 150}px)`;
      }, {passive:true});
    }

    // tiny starfield
    const c = document.getElementById('fx-stars');
    if (c){
      const ctx = c.getContext('2d');
      let W, H, stars=[];
      function resize(){ W = c.width = window.innerWidth; H = c.height = window.innerHeight; make(); }
      function make(){
        const n = Math.min(200, Math.floor(W*H/9000));
        stars = Array.from({length:n}, ()=>({x:Math.random()*W, y:Math.random()*H, z:Math.random()*2+0.5, r:Math.random()*1.2+0.2}));
      }
      function tick(){
        ctx.clearRect(0,0,W,H);
        ctx.fillStyle = '#fff';
        stars.forEach(s=>{
          s.x -= s.z*0.15; if (s.x < -5) s.x = W + Math.random()*20, s.y = Math.random()*H;
          ctx.globalAlpha = 0.3 + s.z*0.35;
          ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
        });
        requestAnimationFrame(tick);
      }
      resize(); tick(); window.addEventListener('resize', resize);
    }
  })();
  </script>
</div></body>
</html>
